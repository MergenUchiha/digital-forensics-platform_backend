generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(ANALYST)
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdCases  Case[]     @relation("CaseCreator")
  assignedCases Case[]     @relation("CaseAssignee")
  evidence      Evidence[]
  chainOfCustody ChainOfCustodyEntry[]

  @@map("users")
}

enum Role {
  ADMIN
  ANALYST
  VIEWER
}

// Case Model
model Case {
  id          String       @id @default(uuid())
  title       String
  description String       @db.Text
  status      CaseStatus   @default(OPEN)
  severity    Severity
  tags        String[]
  
  // Location data (optional)
  locationCity    String?
  locationCountry String?
  locationLat     Float?
  locationLng     Float?
  
  // Stats
  evidenceCount       Int @default(0)
  eventsCount         Int @default(0)
  suspiciousActivities Int @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  createdById String
  createdBy   User   @relation("CaseCreator", fields: [createdById], references: [id])
  
  assignedToId String?
  assignedTo   User?   @relation("CaseAssignee", fields: [assignedToId], references: [id])

  evidence       Evidence[]
  timelineEvents TimelineEvent[]

  @@map("cases")
}

enum CaseStatus {
  OPEN
  IN_PROGRESS
  CLOSED
  ARCHIVED
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

// Evidence Model
model Evidence {
  id          String       @id @default(uuid())
  name        String
  type        EvidenceType
  description String?      @db.Text
  
  // File info
  filePath    String?
  fileSize    Int?
  
  // Hashes
  md5Hash     String
  sha256Hash  String
  
  // Metadata
  metadata    Json?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)
  
  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id])
  
  chainOfCustody ChainOfCustodyEntry[]

  @@map("evidence")
}

enum EvidenceType {
  LOG
  NETWORK_CAPTURE
  DISK_IMAGE
  MEMORY_DUMP
  FILE
  API_RESPONSE
}

// Chain of Custody
model ChainOfCustodyEntry {
  id        String   @id @default(uuid())
  action    CustodyAction
  notes     String?  @db.Text
  signature String?
  
  timestamp DateTime @default(now())

  // Relations
  evidenceId String
  evidence   Evidence @relation(fields: [evidenceId], references: [id], onDelete: Cascade)
  
  performedById String
  performedBy   User   @relation(fields: [performedById], references: [id])

  @@map("chain_of_custody")
}

enum CustodyAction {
  COLLECTED
  ANALYZED
  TRANSFERRED
  EXPORTED
  MODIFIED
}

// Timeline Events
model TimelineEvent {
  id          String        @id @default(uuid())
  timestamp   DateTime
  type        EventType
  source      String
  severity    Severity
  title       String
  description String        @db.Text
  
  // Metadata
  metadata    Json?
  
  // Related entities (stored as JSON arrays)
  ipAddresses String[]
  usernames   String[]
  files       String[]
  devices     String[]
  
  createdAt DateTime @default(now())

  // Relations
  caseId String
  case   Case   @relation(fields: [caseId], references: [id], onDelete: Cascade)

  @@map("timeline_events")
}

enum EventType {
  AUTHENTICATION
  NETWORK
  FILE_ACCESS
  SYSTEM
  API_CALL
  ALERT
}